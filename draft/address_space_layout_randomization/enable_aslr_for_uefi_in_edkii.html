
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Enable ASLR for UEFI in EDK II Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="enable_aslr_for_smm_in_edkii.html" />
    
    
    <link rel="prev" href="aslr_requirement_in_uefi_firmware.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    A Tour Beyond BIOS - Security Enhancement to Mitigate Buffer Overflow in UEFI
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../executive-summary.html">
            
                <a href="../executive-summary.html">
            
                    
                    Executive Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../stack_canaries/">
            
                <a href="../stack_canaries/">
            
                    
                    Stack Canaries
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../stack_canaries/stack_check_support_in_microsoft_visual_studio.html">
            
                <a href="../stack_canaries/stack_check_support_in_microsoft_visual_studio.html">
            
                    
                    Stack Check Support in Microsoft Visual Studio
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../stack_canaries/stack_check_support_in_gcc.html">
            
                <a href="../stack_canaries/stack_check_support_in_gcc.html">
            
                    
                    Stack Check Support in GCC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../stack_canaries/enable_stack_check_in_edkii.html">
            
                <a href="../stack_canaries/enable_stack_check_in_edkii.html">
            
                    
                    Enable Stack Check in EDK II
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../stack_canaries/future_work.html">
            
                <a href="../stack_canaries/future_work.html">
            
                    
                    Future work
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../data_execution_protection/">
            
                <a href="../data_execution_protection/">
            
                    
                    Data Execution Protection
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../data_execution_protection/dep_in_x86_processor.html">
            
                <a href="../data_execution_protection/dep_in_x86_processor.html">
            
                    
                    DEP in X86 Processor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../data_execution_protection/dep_in_uefi_specification.html">
            
                <a href="../data_execution_protection/dep_in_uefi_specification.html">
            
                    
                    DEP in UEFI specification
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../data_execution_protection/enable_dep_in_edkii.html">
            
                <a href="../data_execution_protection/enable_dep_in_edkii.html">
            
                    
                    Enable DEP in EDK II
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../data_execution_protection/future_work.html">
            
                <a href="../data_execution_protection/future_work.html">
            
                    
                    Future work
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="./">
            
                <a href="./">
            
                    
                    Address Space Layout Randomization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="aslr_in_windows.html">
            
                <a href="aslr_in_windows.html">
            
                    
                    ASLR in Windows
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="aslr_in_nix.html">
            
                <a href="aslr_in_nix.html">
            
                    
                    ASLR in *nix
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="aslr_requirement_in_uefi_firmware.html">
            
                <a href="aslr_requirement_in_uefi_firmware.html">
            
                    
                    ASLR requirement in UEFI firmware
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.4" data-path="enable_aslr_for_uefi_in_edkii.html">
            
                <a href="enable_aslr_for_uefi_in_edkii.html">
            
                    
                    Enable ASLR for UEFI in EDK II
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="enable_aslr_for_smm_in_edkii.html">
            
                <a href="enable_aslr_for_smm_in_edkii.html">
            
                    
                    Enable ASLR for SMM in EDK II
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="future_work.html">
            
                <a href="future_work.html">
            
                    
                    Future work
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../additional_overflow_detection/">
            
                <a href="../additional_overflow_detection/">
            
                    
                    Additional Overflow Detection
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../additional_overflow_detection/stack_overflow_detection.html">
            
                <a href="../additional_overflow_detection/stack_overflow_detection.html">
            
                    
                    Stack Overflow Detection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../additional_overflow_detection/heap_management_in_edkii.html">
            
                <a href="../additional_overflow_detection/heap_management_in_edkii.html">
            
                    
                    Heap Management in EDKII
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../additional_overflow_detection/heap_overflow_detection_for_page.html">
            
                <a href="../additional_overflow_detection/heap_overflow_detection_for_page.html">
            
                    
                    Heap Overflow Detection (for Page)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../additional_overflow_detection/heap_overflow_detection_for_pool.html">
            
                <a href="../additional_overflow_detection/heap_overflow_detection_for_pool.html">
            
                    
                    Heap Overflow Detection (for Pool)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../additional_overflow_detection/null_pointer_protection_in_edkii.html">
            
                <a href="../additional_overflow_detection/null_pointer_protection_in_edkii.html">
            
                    
                    NULL Pointer Protection in EDK II
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="../additional_overflow_detection/read-only_page_table.html">
            
                <a href="../additional_overflow_detection/read-only_page_table.html">
            
                    
                    Read-only page table
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="../additional_overflow_detection/limitation.html">
            
                <a href="../additional_overflow_detection/limitation.html">
            
                    
                    Limitation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="../additional_overflow_detection/compatibility_consideration.html">
            
                <a href="../additional_overflow_detection/compatibility_consideration.html">
            
                    
                    Compatibility Consideration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="../additional_overflow_detection/call_for_action.html">
            
                <a href="../additional_overflow_detection/call_for_action.html">
            
                    
                    Call for action
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.10" data-path="../additional_overflow_detection/future_work.html">
            
                <a href="../additional_overflow_detection/future_work.html">
            
                    
                    Future work
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../summary/">
            
                <a href="../summary/">
            
                    
                    Summary
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../summary/policy_control.html">
            
                <a href="../summary/policy_control.html">
            
                    
                    Policy Control
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../references/">
            
                <a href="../references/">
            
                    
                    References
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

	
    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Enable ASLR for UEFI in EDK II</a>
    </h1>
</div>
<div>
    <!-- 
    <img style="float:left; align:middle; height:2em" src="media/TianocoreTitlePageLogo.jpg"/>
     -->
    
      <h2>
        <div style="position:absolute;text-align:left">Security Enhancement to Mitigate Buffer Overflow in UEFI</div>
        <div style="position:absolute;width:100%;text-align:center">DRAFT </div>
        <div style="text-align:right">Revision 02.0</div>
      </h2>  
    
    <hr>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
                                <section class="normal markdown-section">
                                
                                <!--- @file
 Address Space Layout Randomization file: Enable ASLR for UEFI in EDK II

  Copyright (c) 2018, Intel Corporation. All rights reserved.<BR>

  Redistribution and use in source (original document form) and 'compiled'
  forms (converted to PDF, epub, HTML and other formats) with or without
  modification, are permitted provided that the following conditions are met:

  1) Redistributions of source code (original document form) must retain the
     above copyright notice, this list of conditions and the following
     disclaimer as the first lines of this file unmodified.

  2) Redistributions in compiled form (transformed to other DTDs, converted to
     PDF, epub, HTML and other formats) must reproduce the above copyright
     notice, this list of conditions and the following disclaimer in the
     documentation and/or other materials provided with the distribution.

  THIS DOCUMENTATION IS PROVIDED BY TIANOCORE PROJECT "AS IS" AND ANY EXPRESS OR
  IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO
  EVENT SHALL TIANOCORE PROJECT  BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
  OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
  OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS DOCUMENTATION, EVEN IF
  ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

-->
<h2 id="enable-aslr-for-uefi-in-edkii">Enable Address Sace Layout Randomization (ASLR) for UEFI in EDK II </h2>
<p>In order to enable address space layout randomization, we provide a sample implementation for randomization in UEFI.</p>
<ul>
<li><p><strong>Randomization control</strong>.
The <code>gEfiAslrPkgTokenSpaceGuid.PcdASLRMinimumEntropyBits</code> (<a href="https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/AslrPkg.dec" target="_blank">https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/AslrPkg.dec</a>) to indicate the ASLR entropy bits. 0 means no randomization.
The entropy bit controls the how much randomness we want to achieve.</p>
</li>
<li><p><strong>UEFI stack randomization</strong>. 
The stack for <code>DxeCore</code> is allocated in <code>HandOffToDxeCore()</code> <a href="https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/Override/MdeModulePkg/Core/DxeIplPeim/DxeLoad.c" target="_blank">https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/Override/MdeModulePkg/Core/DxeIplPeim/DxeLoad.c</a>. Before the Driver eXecution Environment (DXE) stack is allocated from heap in the Pre-EFI Initialization (PEI) phase, <code>AllocateRandomPages()</code> is called to allocate some random pages to shift the PEI heap.</p>
</li>
<li><p><strong>DxeCore randomization</strong>.
The <code>DxeCore</code> is also loaded from PEI heap by <code>DxeIplFindDxeCore()</code> <a href="https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/Override/MdeModulePkg/Core/DxeIplPeim/DxeLoad.c" target="_blank">https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/Override/MdeModulePkg/Core/DxeIplPeim/DxeLoad.c</a>. <code>AllocateRandomPages()</code> also helps shift the <code>DxeCore</code> memory.</p>
</li>
<li><p><strong>UEFI heap randomization</strong>.
The heap for <code>DxeCore</code> is reported by PEI and discovered by <code>DxeCore</code> in <a href="https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/Override/MdeModulePkg/Core/Dxe/Gcd/Gcd.c" target="_blank">https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/Override/MdeModulePkg/Core/Dxe/Gcd/Gcd.c</a>. After <code>CoreInitializeMemoryServices()</code> adds available memory to UEFI heap, <code>AllocateRandomPages()</code> is called to allocate some random pages to shift the UEFI heap.</p>
<p><strong> NOTE:</strong> The OS aware memory, such as runtime, ACPI, and reserved memory are pre-reserved in PEI phase. They are not impacted by the UEFI heap randomization.</p>
<p>The final memory layout in UEFI is shown in figure 3-4.</p>
<p><img src="../media/image7.png" alt=""></p>
</li>
</ul>
<h6 id="figure-3-4-uefi-memory-layout">Figure 3-4 UEFI memory layout</h6>
<ul>
<li><p><strong>UEFI image randomization</strong>.
The UEFI randomized heap shifts are implemented with a fixed offset. As such, even memory allocation shifts occur with the fixed offset. It is not good enough for a Portable Executable (PE) Common Object File Format(COFF)  (PE/COFF) image load.</p>
<p>For PE/COFF images we use &#x201C;<em>image shuffle</em>&#x201D; to randomize the image load order. Whenever the <code>DxeCore</code> discovers a new firmware volume (FV), the <code>DxeCore</code> unconditionally load all the images in this FV with a random order. See figure 3-5 Image shuffle.</p>
</li>
</ul>
<p><img src="../media/image8.png" alt=""></p>
<h6 id="figure-3-5-image-shuffle">Figure 3-5 Image Shuffle</h6>
<p>For example, if a FV contains 4 images &#x2013; A, B, C, D. The loaded image order in memory is different among the 1<sup>st</sup> boot, the 2<sup>nd</sup> boot, and the 3<sup>rd</sup> boot.</p>
<p>Now let&#x2019;s see how the Core shuffles images.</p>
<p>The <code>DxeCore</code> maintains the image information in below data structure:</p>
<p><img src="../media/image9.png" alt=""></p>
<h6 id="figure-3-6-core-image-database">Figure 3-6 Core Image Database</h6>
<p>The top left most <code>mDiscoveredList</code> is a linked list for all discovered images in the firmware volume. The <code>mScheduledQueue</code> is a subset of <code>mDiscoveredList</code> and <code>mScheduledQueue</code> records the linked list of the image whose dependency is satisfied and ready to run.</p>
<p>The pseudo code for current core dispatch is below:</p>
<pre><code>==============================

Scan FV, put to DiscoveredList.
Check Apriori, put to Scheduled List.
While (TRUE) {
  For image in ScheduledList {
    LoadImage()
    call entrypoint // StartImage()
  }
  Check dependency, put to Scheduled List.
}

==============================
</code></pre><p>With ASLR capability, the core dispatch logic is updated to below:</p>
<pre><code>==============================
Scan FV, put to DiscoveredList.
</code></pre><pre><code>For image in DiscoveredList {
  Copy Information to local cache
}
Shuffle image order in local cache
For image in local cache {
   LoadImage()
}
</code></pre><p>The code above is the additional step to implement the image shuffle. The <code>LoadImage()</code> is moved earlier.</p>
<pre><code>Check Apriori, put to Scheduled List.
While (TRUE) {
  For image in ScheduledList {
    call entrypoint // StartImage()
  }
  Check dependency, put to Scheduled List.
}
==============================
</code></pre><p>The image shuffle capability is controlled by the Platform Configuration Database (PCD) Variable:  <code>gEfiAslrPkgTokenSpaceGuid.PcdImageShuffleEnable</code>(<a href="https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/AslrPkg.dec" target="_blank">https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/AslrPkg.dec</a>).</p>
<p>When this PCD is TRUE, the <code>DxeCore</code> dispatcher function <code>CoreFwVolEventProtocolNotify()</code>(<a href="https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/Override/MdeModulePkg/Core/Dxe/Dispatcher/Dispatcher.c" target="_blank">https://github.com/jyao1/SecurityEx/blob/master/AslrPkg/Override/MdeModulePkg/Core/Dxe/Dispatcher/Dispatcher.c</a>) calls <code>DxeCoreLoadImages()</code> to load all images with shuffled order before the dependency section is evaluated, as we discussed above.</p>
<p>Image shuffle just controls <em>image load</em>, it does not control <em>image start</em>. The image start process is unchanged. <code>DxeCore</code> only starts an image after its dependency is satisfied.</p>

                                
                                </section>
                            
                        </div>
                    </div>
                    
                    

<div>
    <hr>
    
      <h2>
        <div style="position:absolute;text-align:left">Security Enhancement to Mitigate Buffer Overflow in UEFI</div>
        <div style="position:absolute;width:100%;text-align:center">DRAFT </div>
        <div style="text-align:right">Revision 02.0</div>
      </h2>  
    
</div>



                
            </div>

            
                
                <a href="aslr_requirement_in_uefi_firmware.html" class="navigation navigation-prev " aria-label="Previous page: ASLR requirement in UEFI firmware">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="enable_aslr_for_smm_in_edkii.html" class="navigation navigation-next " aria-label="Next page: Enable ASLR for SMM in EDK II">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Enable ASLR for UEFI in EDK II","level":"1.4.4","depth":2,"next":{"title":"Enable ASLR for SMM in EDK II","level":"1.4.5","depth":2,"path":"address_space_layout_randomization/enable_aslr_for_smm_in_edkii.md","ref":"address_space_layout_randomization/enable_aslr_for_smm_in_edkii.md","articles":[]},"previous":{"title":"ASLR requirement in UEFI firmware","level":"1.4.3","depth":2,"path":"address_space_layout_randomization/aslr_requirement_in_uefi_firmware.md","ref":"address_space_layout_randomization/aslr_requirement_in_uefi_firmware.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{"draft":"yes","title":"Security Enhancement to Mitigate Buffer Overflow in UEFI","version":"Revision 02.0"},"plugins":["puml-aleung"],"pluginsConfig":{"puml-aleung":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"address_space_layout_randomization/enable_aslr_for_uefi_in_edkii.md","mtime":"2020-12-01T07:02:04.432Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-12-01T07:02:33.925Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

